---
title: "Global_Terrorism"
author: "Jonathan Brocksieper & Torben Westphalen"
date: "12/16/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction 

We are going to analyze the Global Terrorism Database (GTD). It is an open 
source database which holds information on terrorism attacks from 1970 to 2017,
excluding 1993. The GTD lost the data of the year 1993 due to a compilation 
error. That's why we don't have any data from that particular year. 
The database is maintained by the National Consortium for the Study of 
Terrorism and Responses to Terrorism (START). The GTD includes over 180,000 
attacks around the world. 

Our research question is: Have terrorism attacks developed over the years?
We are going to focus with the regions of the terrorism attacks, if they 
succeeded or not and look if the amount of victims increased or decreased.
These variables are dependent on the year of the attack. 


## Libraries

These are libraries we are going to use for our research. We are using an older
version of the "gganimate" package since the new one has not been well 
documented for our needs.

Since we have a focus on the location of the terrorism attacks, we thought that
we can visualize them in a map. Therefore we use the libraries "ggmap" and 
"mapdata".

```{r}
#remove.packages("gganimate")
#install.packages("data.table")
#install.packages("sf")
#install.packages("ggmap")
#install.packages("mapdata")
#install.packages("devtools")
#install_github("thomasp85/gganimate", ref = "v0.1.1")
#install.packages("https://github.com/thomasp85/gganimate/archive/v0.1.1.tar.gz", repos = NULL, type = "source")

#library("devtools")
library(data.table)
library(dplyr)
library(ggplot2)
library(sf)
library(ggmap)
library(mapdata)
library(gganimate)
```


## Importing dataset

We have uploaded a compressed zip file to a public repository, in case that the 
dataset gets removed from our source.  
We are also replacing the empty cells with "NA" cells to make the use of the 
is.na easier. This helps us tidying up the dataset.

```{r}
if (!file.exists("globalterrorism_dataset.zip")) {
    download.file("https://github.com/JBrO910/DASC_Research/raw/main/globalterrorism_dataset.zip",
                  "globalterrorism_dataset.zip")
    unzip("globalterrorism_dataset.zip")
}

globalterrorism <- read.csv("globalterrorism.csv", na.strings = c("", "NA"), header = TRUE)
#globalterrorism
```

## Deleting columns with more than 90% missing values

As we looked over the dataset, we have found out that many columns have a lot or
almost none filled rows. So we decided that all columns that have more than 
90 % missing values shall be removed. Our intention is that we only use the 
columns that have enough cells with useful data.

```{r}
na_count <- sapply(globalterrorism, function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(na_count)

# Get row name as a column 
na_count_table <- setDT(na_count, keep.rownames = TRUE)[]
na_count_table <- data.frame(na_count_table)

# Calculate the percentage of missing values. Limit to two decimals after the dot.
na_percentage <- sapply(na_count_table$na_count, function(x) as.double(format(round( x/nrow(globalterrorism ), 2), nsmall = 2)))
na_percentage_table <- data.frame(na_count_table, na_percentage)

# Filtering so that only the rows exist that are have less than 90 % missing values
na_percentage_filtered <- subset(na_percentage_table, na_percentage_table$na_percentage < 0.90)

# Removal of the columns
globalterrorism_done <- globalterrorism %>% select(one_of(na_percentage_filtered$rn))
```

## World map with all locations of terrorism attacks

We created a map and set a point for each location of a terrorism attack. 
In the dataset we have the longitude and latitude coordinates of each 
terrorism attack. With these coordinates we can set a point on the map.
We also animated the map by cycling through the years. This helps with the the 
overall visibility of the map.

WARNING: The compilation of this map may take a few minutes!

```{r}
# Retrieving all coordinates from the dataset. But the NA values have to be filtered out first.
globalterrorism_coordinates <- globalterrorism_done %>% filter(!is.na(globalterrorism_done$longitude)) 

# We have found out that one of the coordinates has been added incorrect. Therefore we are also filtering that out.
globalterrorism_coordinates <- globalterrorism_coordinates %>% filter(globalterrorism_coordinates$longitude > -180)

# Create start and end variables for the animation
map_animation_start <- tibble(iyear = 1969, longitude = 0, latitude = 0)
map_animation_end <- tibble(iyear = 2018, longitude = 0, latitude = 0)

# Setting up the map
map_base <- map("worldHires", fill = T, plot = F)
map_base <- st_as_sf(map_base)
map_base <- st_make_valid(map_base)

# Adding the points to the map. The start and end variables for the animation are also added here. We are also doing additional labeling for longitude and latitude.
points_map <- ggplot() + geom_sf(data = map_base) + 
  geom_point(aes(x = longitude, y = latitude,
                 frame = iyear,
                 cumulative = TRUE),
             data = globalterrorism_coordinates, colour = "purple",  size = 1) +
  geom_point(aes(x = longitude, y = latitude,
                 frame = iyear,
                 cumulative = TRUE),
             data = map_animation_start, colour = "purple", size = 0) +
  geom_point(aes(x = longitude, y = latitude,
                 frame = iyear,
                 cumulative = TRUE),
             data = map_animation_end, colour = "purple", size = 0) +
  labs(x = "Longitude", y = "Latitude", fill = "") +
  theme_bw() +
  theme(panel.grid = element_line(colour = "transparent"),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 16),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14))

# Start animation with an interval of 0.2 seconds.
gganimate(points_map, interval = 0.2) 
```


## Number of terrorism attacks every year (excluding 1993)

```{r}
ggplot(data = globalterrorism_done, mapping = aes(iyear)) +
  geom_bar(stat = "count")
```


## Amount of victims 


```{r}
globalterrorism_kill <- globalterrorism_done %>% filter(!is.na(nkill)) 

ggplot(data = globalterrorism_kill, mapping = aes(x = iyear, y = nkill)) +
  geom_bar(stat = "identity") +
  xlab("Years") +
  ylab("Amount of victims") +
  ggtitle("Amount of victims for each year")
```